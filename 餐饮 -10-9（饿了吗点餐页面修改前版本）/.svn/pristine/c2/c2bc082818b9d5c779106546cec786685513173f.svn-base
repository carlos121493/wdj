// pages/index/mjq.js
var config = require("../../config.js");
Page({
  data: {
    api:config.apiPath,
    mjList: '',
    order: '',
    orderId: '',
    from:'',
  },
  onLoad: function (options) {
    var that = this;
    var id = options.id;
    if (!wx.getStorageSync('color')) {
      wx.setStorageSync('color', 'blue');
    }
    config.navBarColor(wx.getStorageSync('color'));
    that.setData({
      order: wx.getStorageSync('order'),
      orderId: options.id,
      color: wx.getStorageSync('color')
    })
    
    if (options.from == 'wm') {
      that.setData({
        from: options.from
      })
      config.post("/wxApi/wm/getCoupons", { id: id, type: 1 }, function (ret) {
        if (ret.code == 0) {
          that.setData({
            mjList: ret.data
          })
        } else {
          config.tost(ret.msg);
        }
      });
      }else{
      config.post("/wxApi/o/getCoupons", { id: id, type: 1 }, function (ret) {
        if (ret.code == 0) {
          that.setData({
            mjList: ret.data
          })
        } else {
          config.tost(ret.msg);
        }
      });
      }    
  },
  liselec: function (e) {
    var that = this;
    var index = e.currentTarget.dataset.index;
    var id = e.currentTarget.dataset.id;
    that.setData({
      liselec: index
    })
    if (id == '') {
      that.data.order.mjId = "";
      that.setData({
        order: that.data.order
      })
      id = "noMj";
    } if (that.data.from == 'wm') {
      setTimeout(function () {
        config.post("/wxApi/wm/selectCoupon", { id: that.data.orderId, couponId: id }, function (ret) {
          if (ret.code == 0) {
            if (id) {
              that.data.order.mjId = id;
              that.setData({
                order: that.data.order
              })
            }
            wx.navigateBack({
              delta: 1
            })
          } else {
            config.tost(ret.msg);
          }
        });
      }, 100)
    }else{    
    setTimeout(function () {
      config.post("/wxApi/o/selectCoupon", { id: that.data.orderId, couponId: id }, function (ret) {
        if (ret.code == 0) {
          if (id) {
              that.data.order.mjId = id;
              that.setData({
                order: that.data.order
              })
          }
          wx.navigateBack({
            delta: 1
          })  
        } else {
          config.tost(ret.msg);
        }
      });
    }, 100)
    }
  },
})